#!/usr/bin/env python

import wsgiref.handlers
from xml.dom.minidom import getDOMImplementation
import zlib

from Movie import Movie
from Person import Person 
from Lookup import LookupHandler

from google.appengine.ext import webapp
from google.appengine.ext import db
from google.appengine.api import memcache

import imdb

class LookupMovieHandler(LookupHandler):
  def get_test(self):
    var = """<?xml version="1.0" encoding="utf-8"?><result><producers><person id="0209326" name="La Noy, Kevin De"><characters><character name="executive producer"/></characters></person><person id="2044373" name="Goldberg, Jordan"><characters><character name="associate producer"/></characters></person><person id="0573294" name="McMillan, Karl"><characters><character name="production associate producer"/></characters></person><person id="0578195" name="Melniker, Benjamin"><characters><character name="executive producer"/></characters></person><person id="0634240" name="Nolan, Christopher"><characters><character name="producer"/></characters></person><person id="0746273" name="Roven, Charles"><characters><character name="producer"/></characters></person><person id="0858799" name="Thomas, Emma"><characters><character name="producer"/></characters></person><person id="2100078" name="Tull, Thomas"><characters><character name="executive producer"/></characters></person><person id="0882388" name="Uslan, Michael E."><characters><character name="executive producer"/></characters></person></producers><writers><person id="0634300" name="Nolan, Jonathan"/><person id="0634240" name="Nolan, Christopher"/><person id="0333060" name="Goyer, David S."/><person id="0004170" name="Kane, Bob"/></writers><directors><person id="0634240" name="Nolan, Christopher"/></directors><music><person id="0006133" name="Howard, James Newton"/><person id="0001877" name="Zimmer, Hans"/></music><cast><person id="0000288" name="Bale, Christian"><characters><character id="0000177" name="Bruce Wayne"/><character id="0000177" name="Batman"/></characters></person><person id="0005132" name="Ledger, Heath"><characters><character id="0000180" name="The Joker"/></characters></person><person id="0001173" name="Eckhart, Aaron"><characters><character id="0000190" name="Harvey Dent"/><character id="0000190" name="Two-Face"/></characters></person><person id="0000323" name="Caine, Michael"><characters><character id="0000204" name="Alfred Pennyworth"/></characters></person><person id="0350454" name="Gyllenhaal, Maggie"><characters><character id="0000182" name="Rachel Dawes"/></characters></person><person id="0000198" name="Oldman, Gary"><characters><character id="0000248" name="Lt. James Gordon"/></characters></person><person id="0000151" name="Freeman, Morgan"><characters><character id="0000187" name="Lucius Fox"/></characters></person><person id="1010931" name="Curnen, Monique"><characters><character id="0056993" name="Det. Ramirez"/></characters></person><person id="0212939" name="Dean, Ron"><characters><character id="0093489" name="Detective Wuertz"/></characters></person><person id="0614165" name="Murphy, Cillian"><characters><character id="0000186" name="Dr. Jonathan Crane"/><character id="0000186" name="The Scarecrow"/></characters></person><person id="1977856" name="Han, Chin"><characters><character id="0093490" name="Lau"/></characters></person><person id="0004801" name="Carbonell, Nestor"><characters><character id="0058454" name="Mayor"/></characters></person><person id="0000616" name="Roberts, Eric"><characters><character id="0039109" name="Salvatore Maroni"/></characters></person><person id="0182662" name="Coster, Ritchie"><characters><character id="0073685" name="The Chechen"/></characters></person><person id="0001309" name="Hall, Anthony Michael"><characters><character id="0047368" name="Mike Engel"/></characters></person><person id="0843775" name="Szarabajka, Keith"><characters><character name="Detective Stephens"/></characters></person><person id="0568801" name="McFarlane, Colin"><characters><character id="0057658" name="Commissioner Gillian B. Loeb"/></characters></person><person id="0367176" name="Harto, Joshua"><characters><character id="0034280" name="Reese"/></characters></person><person id="0569927" name="McGraw, Melinda"><characters><character id="0038541" name="Barbara Gordon"/></characters></person><person id="1997480" name="Gamble, Nathan"><characters><character id="0040002" name="James Gordon Jr."/></characters></person><person id="2312716" name="Vieau, Michael"><characters><character name="Al Rossi"/></characters></person><person id="0832989" name="Stoyanov, Michael"><characters><character name="Dopey"/></characters></person><person id="2624644" name="Smiley, William"><characters><character name="Happy"/></characters></person><person id="0325975" name="Goldring, Danny"><characters><character name="Grumpy"/></characters></person><person id="0925227" name="White, Michael Jai"><characters><character name="Gambol"/></characters></person><person id="1115978" name="O'Neill, Matthew"><characters><character name="Chuckles"/></characters></person><person id="0001209" name="Fichtner, William"><characters><character id="0032981" name="Bank Manager"/></characters></person><person id="3059370" name="Olawumi, Lumiji"><characters><character name="Drug Dealer"/></characters></person><person id="1716697" name="Beam, Gregory"><characters><character name="Drug Buyer"/></characters></person><person id="3059371" name="Hellman, Erik"><characters><character name="Junkie"/></characters></person><person id="0742389" name="Rosen, Beatrice"><characters><character name="Natascha"/></characters></person><person id="0630405" name="Nicoli, Vincenzo"><characters><character name="Crime Boss"/></characters></person><person id="0155211" name="Chen, Edison"><characters><character name="LSI VP"/></characters></person><person id="0855738" name="Terracina, Nydia Rodriguez"><characters><character name="Judge Surrillo"/></characters></person><person id="2997530" name="Luther, Andy"><characters><character name="Brian"/></characters></person><person id="2324587" name="Farruggio, James"><characters><character name="Man No. 1"/></characters></person><person id="0568458" name="McElroy, Tom"><characters><character name="Man No. 2"/></characters></person><person id="0952040" name="Zahrn, Will"><characters><character name="Assistant DA"/></characters></person><person id="0276441" name="Fierro, James"><characters><character name="Thug at Party"/></characters></person><person id="0495004" name="Leahy, Patrick"><characters><character name="Gentleman at Party"/></characters></person><person id="0220308" name="Derence, Sam"><characters><character name="Male Guest"/></characters></person><person id="2029513" name="Knox, Jennifer"><characters><character name="Female Guest"/></characters></person><person id="0165816" name="Clear, Patrick"><characters><character name="Judge Freel"/></characters></person><person id="0242759" name="Dunn, Sarah Jayne"><characters><character name="Maroni's Mistress"/></characters></person><person id="1111200" name="Venice, Chucky"><characters><character name="Gambol's Bodyguard #1"/></characters></person><person id="0255148" name="Ellis, Winston"><characters><character name="Gambol's Bodyguard #2"/></characters></person><person id="2810287" name="Dastmalchian, David"><characters><character name="Joker's Thug"/></characters></person><person id="3060002" name="Hinshelwood, Sophia"><characters><character name="Reporter"/></characters></person><person id="1199547" name="Kupferer, Keith"><characters><character name="Heckler"/></characters></person><person id="0127438" name="Caballero, Joseph Luis"><characters><character name="Cop Heckler"/></characters></person><person id="0226819" name="Dillane, Richard"><characters><character name="Acting Commissioner"/></characters></person><person id="1699095" name="Satcher, Daryl"><characters><character name="Officer at Intersection"/></characters></person><person id="3059740" name="Petschler, Chris"><characters><character name="Convoy Leader"/></characters></person><person id="3059726" name="Feore, Aidan"><characters><character name="Fat Thug"/></characters></person><person id="1711389" name="Bulcock, Philip"><characters><character name="Detective Murphy"/></characters></person><person id="0083307" name="Birchard, Paul"><characters><character name="Cop with Fat Thug"/></characters></person><person id="0507860" name="Lewis, Walter"><characters><character name="Medic"/></characters></person><person id="0725664" name="Riotta, Vincent"><characters><character name="Cop at 250 52nd St."/></characters></person><person id="0186406" name="Crane, Nancy"><characters><character name="Nurse"/></characters></person><person id="0293461" name="Freeman, K. Todd"><characters><character name="Polk"/></characters></person><person id="2754138" name="Shallenberger, Matt"><characters><character name="Berg"/></characters></person><person id="0331106" name="Gorman, Michael Andrew"><characters><character name="Cop at Hospital"/></characters></person><person id="3060034" name="Lutz, Lanny"><characters><character name="Bartender"/></characters></person><person id="1197191" name="Defaria, Peter"><characters><character name="Civilian"/></characters></person><person id="1208061" name="Rippy, Matt"><characters><character name="First Mate"/></characters></person><person id="0081070" name="Bicknell, Andrew"><characters><character name="Prison Ferry Pilot"/></characters></person><person id="0048159" name="Bakare, Ariyon"><characters><character name="Guard Commander"/></characters></person><person id="0050607" name="Ballard, Doug"><characters><character name="Businessman"/></characters></person><person id="0933498" name="Wilson, Helene"><characters><character name="Mother"/></characters></person><person id="1035174" name="Campbell, Tommy"><characters><character name="Passenger #1"/></characters></person><person id="1035498" name="Heaney, Craig"><characters><character name="Passenger #2"/></characters></person><person id="1452416" name="Gayle, Lorna"><characters><character name="Passenger #3"/></characters></person><person id="1933893" name="McAllister, Lisa"><characters><character name="Passenger #4"/></characters></person><person id="0111730" name="Brooke, Peter"><characters><character name="Passenger #5"/></characters></person><person id="2024154" name="Rollins, Joshua"><characters><character name="SWAT Sniper"/></characters></person><person id="0729237" name="Rivera, Dale"><characters><character name="SWAT Leader"/></characters></person><person id="0500614" name="Leitch, Matthew"><characters><character name="Prisoner on Ferry"/></characters></person><person id="0001474" name="Lister, Tommy 'Tiny'"><characters><character name="Tattooed Prisoner"/></characters></person><person id="3060087" name="Gaitsch, Thomas"><characters><character name="Reporter #3"/></characters></person><person id="0035628" name="Armstrong, William"><characters><character name="Evans"/></characters></person><person id="2643690" name="Kalesperis, Adam"><characters><character name="Honor Guard Man"/></characters></person><person id="0846925" name="Tait, Tristan"><characters><character name="Uniform Cop"/></characters></person><person id="0916037" name="Webb, Bronson"><characters><character name="Bounty Hunter #1"/></characters></person><person id="2916966" name="Ajala, David"><characters><character name="Bounty Hunter #2"/></characters></person><person id="3059516" name="Kyles, Gertrude"><characters><character name="Fox's Secretary"/></characters></person><person id="0753322" name="Ryland, Jonathan"><characters><character name="Passenger Ferry Pilot"/></characters></person><person id="0768790" name="Scales, James"><characters><character name="Guardsman"/></characters></person><person id="0140585" name="Carrington, Nigel"><characters><character name="Warden"/></characters></person><person id="1128414" name="Pirie, Ian"><characters><character name="Corrections Officer"/></characters></person><person id="3059545" name="Lovejoy, Lateef"><characters><character name="Prisoner #1"/></characters></person><person id="3060088" name="Edwards, Grahame"><characters><character name="Prisoner #2"/></characters></person><person id="0598236" name="Monk, Roger"><characters><character name="Prisoner #3"/></characters></person><person id="2788751" name="Summers, Ronan"><characters><character name="Prisoner #4"/></characters></person><person id="2647349" name="Wong, Wai"><characters><character name="Hong Kong Detective"/></characters></person><person id="3059835" name="Foster, Michael Corey"><characters><character name="Honor Guard Leader"/></characters></person><person id="3060152" name="Gunn, Hannah"><characters><character name="Gordon's Daughter"/></characters></person><person id="0483029" name="Lambdin, Brandon"><characters><character name="Armored Car SWAT"/></characters></person><person id="2454294" name="Albertson, Jeff"><characters><character id="0082131" name="Gotham Police Officer"/></characters></person><person id="2100778" name="Armourae, Stephen"><characters><character name="Kirk Stedden"/></characters></person><person id="2860863" name="Bartlett, Tommy"><characters><character name="Salvatore Maroni's Defense Attorney"/></characters></person><person id="0131689" name="Cameron-Blakey, Nadia"><characters><character name="Cressida Spink"/></characters></person><person id="1322496" name="Cho, Jamie"><characters><character name="Lau's Bodyguard"/></characters></person><person id="2611858" name="Clevenger, Kelli"><characters><character id="0082478" name="Paramedic"/></characters></person><person id="2970637" name="Cooper, Martyn"><characters><character name="Prisoner"/></characters></person><person id="2793034" name="Fuller, Jay"><characters><character name="Prisoner"/></characters></person><person id="2459962" name="Hansen, Steven H."><characters><character name="Maroni Henchman"/></characters></person><person id="2203410" name="Hilgendorf, Julie"><characters><character name="Russian Ballerina"/></characters></person><person id="2803526" name="Kress, Don"><characters><character name="Maroni Henchman"/></characters></person><person id="2955982" name="Latham, Dan"><characters><character name="Police Sgt. Spellman - Gotham Bomb Squad"/></characters></person><person id="2945054" name="Lyubomirova, Angelina"><characters><character name="Ballerina"/></characters></person><person id="1688187" name="Madhav, Sanjay"><characters><character name="Senator"/></characters></person><person id="2972606" name="Mahoney-Bostridge, Teresa"><characters><character name="Refugee"/></characters></person><person id="1201355" name="Mitchell, Dean"><characters><character name="Firefighter"/></characters></person><person id="0662412" name="Parker, Kerri"><characters><character name="Maroni's Mistress"/></characters></person><person id="1026219" name="Snowden, John"><characters><character name="Detective"/></characters></person><person id="1953371" name="Stone, Robert"><characters><character name="Prisoner"/></characters></person><person id="2711324" name="Wilson, Chris"><characters><character name="Gotham MCU Detective"/></characters></person><person id="1948712" name="Ballantyne, Martin"><characters><character name="Jokers Henchman"/></characters></person><person id="2223400" name="Dhiman, Jazz"><characters><character name="Prisoner"/></characters></person><person id="2969897" name="Fojtik, Gene"><characters><character name="Pedestrian"/></characters></person><person id="2772659" name="Fulsher, Darren Elliot"><characters><character name="Police"/></characters></person><person id="2298374" name="Ganyo, Scott"><characters><character name="EMT"/></characters></person><person id="2684278" name="Hodges, Jor'don"><characters><character id="0096578" name="Gotham City Police"/></characters></person><person id="1631845" name="Jimenez, Ramses"><characters><character name="National Guard"/></characters></person><person id="0441588" name="Katt, Nicky"><characters><character name="Shotgun SWAT"/></characters></person><person id="2078498" name="Keiser, Mark"><characters><character name="Business Man / Crime Scene Witness"/></characters></person><person id="2788380" name="Kierscht, Charles"><characters><character name="Guest at Bruce Wayne's Penthouse"/></characters></person><person id="2957579" name="Kosik, Thomas"><characters><character name="Parade police officer"/></characters></person><person id="2787598" name="Mazurk, Joseph"><characters><character name="Court Bailiff / Parade Policeman"/></characters></person><person id="2814697" name="Modell, Stephen"><characters><character name="Prisoner"/></characters></person><person id="2939612" name="Plante, Rory"><characters><character name="Evacuating Hospital Patient"/></characters></person><person id="2811059" name="Seybold, Jan"><characters><character name="Secretary to D.A. Harvey Dent"/></characters></person><person id="2253395" name="Smirnova, Sofiya"><characters><character name="Evacuee"/></characters></person><person id="1979197" name="Stevens, Willie"><characters><character name="Prisoner"/></characters></person><person id="1518153" name="Strobel, Richard"><characters><character name="Detective"/></characters></person><person id="0877149" name="Turk, John"><characters><character name="Chechen bodyguard"/></characters></person><person id="2269943" name="Williams, Erik A."><characters><character name="Wayne Manor Party Guest"/></characters></person><person id="2992757" name="Zaideman, Kevin"><characters><character name="Party Staff"/></characters></person></cast><imageUrl value="http://ia.media-imdb.com/images/M/MV5BMTIzMDc4MzA2Ml5BMl5BanBnXkFtZTcwODU0MzA3MQ@@._V1._SX94_SY140_.jpg"/><genres><genre value="Action"/><genre value="Crime"/><genre value="Drama"/><genre value="Mystery"/><genre value="Thriller"/></genres><outline value="Batman and James Gordon join forces with Gotham's new District Attorney, Harvey Dent, to take on a psychotic bank robber known as The Joker, whilst other forces plot against them, and Joker's crimes grow more and more deadly."/><plot value="Peteagassi::Batman raises the stakes in his war on crime. With the help of Lieutenant Jim Gordon and District Attorney Harvey Dent, Batman sets out to dismantle the remaining criminal organizations that plague the city streets. The partnership proves to be effective, but they soon find themselves prey to a reign of chaos unleashed by a rising criminal mastermind known to the terrified citizens of Gotham as The Joker."/><votes value="4591"/><rating value="9.7"/></result>"""

    self.response.out.write(var)

  def get(self):
    self.get_test()
    return

    memcache.flush_all()    
    q = self.request.get("id")
    listings = self.get_listings_from_cache(q)
    if listings is None:
      self.response.out.write("")
      return

    self.response.out.write(zlib.decompress(listings))


  def get_listings_from_cache(self, q):
    listings = memcache.get("Movie_" + q)

    if listings is None:
      listings = self.get_listings_from_webservice(q)
      memcache.Client().set("Movie_" + q, listings, time=3*24*60*60)

    return listings


  def get_listings_from_webservice(self, q):    
    i = imdb.IMDb(accessSystem='http')
    #movie = i.get_movie(q, info=imdb.Movie.Movie.default_info + ('trivia', 'goofs', 'quotes', 'crazy credits'))
    movie = i.get_movie(q, info=imdb.Movie.Movie.default_info)
    
    document = getDOMImplementation().createDocument(None, "result", None)
    resultElement = document.documentElement
        
    LookupHandler.encodePeople(movie, 'producer', "producers", document, resultElement)
    LookupHandler.encodePeople(movie, 'writer', "writers", document, resultElement)
    LookupHandler.encodePeople(movie, 'director', "directors", document, resultElement)
    LookupHandler.encodePeople(movie, 'original music', "music", document, resultElement)
    LookupHandler.encodePeople(movie, 'cast', "cast", document, resultElement)
            
    if movie.has_key('cover url'):
        element = document.createElement("imageUrl")
        element.setAttribute("value", movie['cover url'])
        resultElement.appendChild(element)
    
    if movie.has_key('genres'):
        element = document.createElement("genres")
        resultElement.appendChild(element)
        for g in movie['genres']:
            genreElement = document.createElement("genre")
            genreElement.setAttribute("value", g)
            element.appendChild(genreElement)
        
    if movie.has_key('plot outline'):
        element = document.createElement("outline")
        element.setAttribute("value", movie['plot outline'])
        resultElement.appendChild(element)
        
    if movie.has_key('plot') and (len(movie['plot']) > 0):
        element = document.createElement("plot")
        element.setAttribute("value", movie['plot'][0])
        resultElement.appendChild(element)
        
    if movie.has_key('votes'):
        element = document.createElement("votes")
        element.setAttribute("value", str(movie['votes']))
        resultElement.appendChild(element)
        
    if movie.has_key('rating'):
        element = document.createElement("rating")
        element.setAttribute("value", str(movie['rating']))
        resultElement.appendChild(element)
        
    return zlib.compress(document.toxml("utf-8"))
